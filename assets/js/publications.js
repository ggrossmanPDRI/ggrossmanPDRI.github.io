(() => {
  // Minimal sample data (add the rest yourself)
  const PUBLISHED = [
	{
      id: 49,
      year: 2026,
      title: "Political Science Under Pressure: Competition and Collaboration in a Growing Discipline, 2003-2023",
      authors: "William Dinneen and Carolina Torreblanca",
      journal: "Perspective on Politics",
      status: "forthcoming",
      categories: ['Knowledge Production'],
      abstract: "This study analyzes the evolution of political science (PS) scholarship using 140,000+ articles from 174 journals (2003–2023). We examine how structural changes—shrinking job markets and increased reliance on publication metrics—affect what gets studied and how. Growing publication pressures push younger scholars to publish more, yet the tripling of PS publication volume stems from a larger contributor base, not individual output. On a positive note, structural shifts have made PS more collaborative, with efficiency gains from team research outweighing credit diffusion. Contrary to fears of topical narrowing, our text-as-data analysis shows consistent topical diversity, though higher-ranked journals form a distinct ecosystem with unique methodological references.",
      links: {
        pdf: "https://osf.io/preprints/osf/tmy37_v3",
        bibtex: `@article{grossman2026political,
  title={Political Science Under Pressure: Competition and Collaboration in a Growing Discipline, 2003-2023},
  author={Grossman, Guy and Dinneen, William and Torreblanca, Carolina},
  journal={Perspective on Politics},
  year={2026},
  status={forthcoming}
}`
      }
    },
    {
      id: 48,
      year: 2026,
      title: "The Politics of Climate Change in the Developing World",
      authors: "Audrey Sacks and Alice Xu",
      journal: "Annual Review of Political Science",
      status: "forthcoming",
      categories: ['Climate Change'],
      abstract: "Climate change politics in the developing world remains understudied, despite the region's acute vulnerability and centrality to climate futures. This review synthesizes emerging research across three domains: public opinion and climate salience, the effects of climate exposure on political accountability, and the institutional production of climate risk. We highlight a core paradox widespread public concern often coexists with limited climate literacy—suggesting that political salience stems from lived experience with environmental disruption rather than scientific attribution.",
      links: {
        pdf: "/assets/pdf/2025_The_Politics_Of_Climate_Change_In_The_Developing_World.pdf",
        bibtex: `@article{grossman2026climate,
  title={The Politics of Climate Change in the Developing World},
  author={Grossman, Guy and Sacks, Audrey and Xu, Alice},
  journal={Annual Review of Political Science},
  year={2026},
  status={forthcoming}
}`
      }
    },
    {
      id: 47,
      year: 2025,
      title: "Ethical Oversight in Impact Evaluations: External Advisory Committees to Assess Programming Risks",
      authors: "Darin Christensen, Allison N. Grossman, Jon Kurtz, Jeremy Weinstein, and Jessica Wolff",
      journal: "Proceedings of the National Academy of Sciences",
      volume: "122(47): e2509773122",
      categories: ['Migration'],
      abstract: "Social scientists not only conduct impact evaluations but also participate in the design and implementation of the programs being evaluated. While Institutional Review Boards (IRBs) oversee research activities, they do not assess risks posed by the interventions themselves. We propose establishing External Advisory Committees (EACs) to provide independent, expert oversight of programming risks.",
      links: {
        pdf: "https://www.pnas.org/doi/epdf/10.1073/pnas.2509773122",
        journal: "https://www.pnas.org/doi/10.1073/pnas.2509773122",
        appendix: "https://www.pnas.org/doi/suppl/10.1073/pnas.2509773122/suppl_file/pnas.2509773122.sapp.pdf",
        bibtex: `@article{grossman2025ethical,
  title={Ethical Oversight in Impact Evaluations: External Advisory Committees to Assess Programming Risks},
  author={Grossman, Guy and Christensen, Darin and Grossman, Allison N. and Kurtz, Jon and Weinstein, Jeremy and Wolff, Jessica},
  journal={Proceedings of the National Academy of Sciences},
  volume={122},
  number={47},
  pages={e2509773122},
  year={2025}
}`
      }
    },
    {
      id: 46,
      year: 2025,
      title: "Do More Disaggregated Electoral Results Deter Aggregation Fraud?",
      authors: "Miguel Rueda and Shuning Ge",
      journal: "British Journal of Political Science",
      volume: "55 (e140): 1-11",
      categories: ['Governance'],
      abstract: "It has been argued that the level at which electoral results are published can affect the election integrity. Publishing more granular results (e.g., at the polling station level) can allow citizens to verify the vote totals that determine election outcomes, thereby deterring voting aggregation fraud. While this logic undergirds the recommendations of international organizations monitoring elections to publish disaggregated electoral results, to date there have not been systematic assessments of how variation in aggregation is linked to electoral miscounting.",
      links: {
        pdf: "/assets/pdf/2025_do_more_disaggregated_electoral_results_deter_aggregation_fraud.pdf",
        journal: "https://www.cambridge.org/core/journals/british-journal-of-political-science/article/do-more-disaggregated-electoral-results-deter-aggregation-fraud/08AFBE74047115114DBA17E841DEFDDE",
        appendix: "/assets/pdf/2025_deter_aggregation_S0007123425100665sup001.pdf",
        replication: "https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/GBR02C",
        bibtex: `@article{grossman2020ict,
  title={Information Technology and Political Engagement: Mixed Evidence from Uganda},
  author={Grossman, Guy and Humphreys, Macartan and Sacramone-Lutz, Gabriella},
  journal={Journal of Politics},
  volume={82},
  number={4},
  pages={1321--1336},
  year={2020}
}`
      }
    },
    {
    id: 45,
    year: 2025,
    title: "Voted In, Standing Out: Public Response to Immigrants’ Political Accession",
    authors: "Stephanie Zonszein, Guy Grossman",
    journal: "American Journal of Political Science",
    volume: "69 (2): 718-733",
    status: "published",
    categories: ['Migration', 'Conflict'],
    abstract: "How do dominant-group natives react to immigrants' political integration? We argue that ethnic minority immigrants winning political office makes natives feel threatened, triggering animosity. We test this dynamic across the 2010–2019 UK general elections, using hate crime police records, public opinion data, and text data from over 500,000 regional and local newspaper articles. While past work has not established a causal relationship between minorities' political power gains and dominant-group animosity, we identify natives' hostile reactions with a regression discontinuity design that leverages close election results between immigrant-origin ethnic minority and dominant-group candidates. We find that minority victories increase hate crimes by 67%, exclusionary attitudes by 66%, and negative media coverage of immigrant groups by 110%. Consistent with power threat and social identity theories, these findings demonstrate a strong and widespread negative reaction—encompassing a violence-prone fringe and the mass public—against ethnic minority immigrants' integration into majority settings.",
    links: {
      pdf: "/assets/pdf/Voted-in-standing-out-Public-response-to-immigrants-political-accession.pdf",
      appendix: "/assets/pdf/ajps12877-sup-0001-suppmat.pdf",
      replication: "https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/IJ2DW4",
      bibtex: `@article{grossman2025votedin,
  title={Voted In, Standing Out},
  author={Zonszein, Stephanie and Grossman, Guy},
  journal={American Journal of Political Science},
  volume={69},
  number={2},
  pages={718-733},
  year={2025},
  status={published}
}`
    }
  },
    {
      id: 44,
      year: 2024,
      title: "Turnout Turnaround: Ethnic Minority Victories Mobilize White Voters.",
      authors: "Guy Grossman (with Stephanie Zonszein)",
      journal: "American Political Science Review",
      status: "published",
      volume: "118",
      issue: "3",
      pages: "1556–1562",
      categories: ["Governance"],
      abstract: "We show that constituencies narrowly won by an ethnic minority candidate experience higher turnout in the next election, driven by majority-white constituencies.",
      links: {
        webpage: "https://doi.org/10.1017/S000305542300103X",
        pdf: "/assets/pdf/turnout-turnaround-ethnic-minority-victories-mobilize-white-voters.pdf",
        appendix: ["/assets/pdf/PSR2300103_Supplementary_Materials.pdf"],
        replication: "https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/UKVOPE",
        bibtex: `@article{grossman2024turnoutturnaround,
  title={Turnout Turnaround: Ethnic Minority Victories Mobilize White Voters},
  author={Grossman, Guy and Zonszein, Stephanie},
  journal={American Political Science Review},
  year={2024},
  volume={118},
  number={3},
  pages={1556--1562}
}`
      }
    },
    {
      id: 26,
      year: 2020,
      title: "Political partisanship influences behavioral responses to governors’ recommendations for COVID-19 prevention in the United States.",
      authors: "Guy Grossman (with Soojong Kim, Jonah M. Rexer, and Harsha Thirumurthy)",
      journal: "Proceedings of the National Academy of Sciences",
      status: "published",
      volume: "117",
      issue: "39",
      pages: "24144–24153",
      categories: ["Governance"],
      abstract: "We assess how partisan preferences shape compliance with governors’ COVID-19 recommendations using mobility data from U.S. counties in March 2020.",
      links: {
        webpage: "https://www.pnas.org/content/early/2020/09/14/2007835117",
        pdf: "/assets/pdf/2020_NAS_PE_political_partisanship.pdf",
        appendix: ["/assets/pdf/political_partisanship_online_appendix.pdf"],
        replication: "https://dataverse.harvard.edu/dataverse/COVID19governors/",
        bibtex: `@article{grossman2020partisanshipcovid,
  title={Political partisanship influences behavioral responses to governors’ recommendations for COVID-19 prevention in the United States},
  author={Grossman, Guy and Kim, Soojong and Rexer, Jonah M. and Thirumurthy, Harsha},
  journal={Proceedings of the National Academy of Sciences},
  year={2020},
  volume={117},
  number={39},
  pages={24144--24153}
}`
      }
    }
  ];

  const WORKING = [
    {
      id: 1,
      title: "Can Community Policing Improve Police-Community Relations in a Low-Income Country Setting?",
      authors: "Robert A. Blair and Anna M. Wilke",
      status: "revise and resubmit",
      categories: ['Governance', 'Conflict'],
      abstract: "Community-oriented policing (COP) is one of the most widely touted mechanisms for building bridges between police forces and the communities they serve.  But evidence on the effectiveness of COP is surprisingly scant. We present results from one of the first randomized controlled trials to evaluate the impact of COP in the Global South. The COP initiative we study was locally designed and funded by the Ugandan government. Contrary to our expectations, we find no evidence that the program reduced crime, enhanced citizens’ perceptions of safety, improved their attitudes towards the police, increased crime reporting, or strengthened other norms of citizen cooperation with the police.   Nor do we find evidence that the program generated greater empathy or accountability among participating police officers themselves. We explore a variety of potential explanations for these null results, including both supply-side factors (e.g., resource constraints within the Ugandan police force) and demand-side factors (e.g., citizens’ fear of engaging with the police). We find no evidence that overcoming these obstacles would make COP more effective.  Taken together, our findings point to potential limitations of COP in low-income countries.",
      links: {
        pdf: "https://osf.io/preprints/osf/wkrcm_v2",
        bibtex: `@unpublished{grossman2024community,
  title={Can Community Policing Improve Police-Community Relations in a Low-Income Country Setting?},
  author={Grossman, Guy and Blair, Robert A. and Wilke, Anna M.},
  note={Revise and resubmit},
  year={2024}
}`
      }
    },
   {
      id: 2,
      title: "Informal Connections Outweigh Co-authorship Ties in Academic Impact",
      authors: "Danús Lluís, William Dinneen, Carolina Torreblanca & Sandra González-Bailón",
      status: "revise and resubmit",
      categories: ['Knowledge Production'],
      abstract: "Research has documented the importance of teamwork in the form of co-authorship for research productivity and innovation, but we know much less about how informal collaborations relate to academic success. Informal ties allow intangible exchanges like mentoring, guidance, and feedback to flow among scholars: these interactions weave a support structure that improves ideas and encourages project growth. However, these informal exchanges are more difficult to measure because they do not leave as clear a trail as co-authorship ties. Here, we uncover this layer of informal communication around scholarly outputs by parsing the information contained in the acknowledgment sections of published articles. Our data include 130,000 articles authored by 86,000 scholars from the period 2003-2023. We analyze scholars’ embeddedness in this informal structure of collaboration and reveal that (1) informal ties create a larger and denser network of support than co-authorship ties; (2) disconnection from informal networks is associated with gaps in productivity and impact; and (3) informal ties are a more relevant predictor of academic success than formal collaborations, even after matching for gender, seniority, methodology, and geographical location. Using coarsened exact matching and random forest regressions we show that informal structures of support are significantly associated with academic impact, creating gaps in who benefits from those connections. ",
      links: {
        bibtex: `@unpublished{grossman2024informal,
  title={Informal Connections Outweigh Co-authorship Ties in Academic Impact},
  author={Grossman, Guy and Danús, Lluís and Dinneen, William and Torreblanca, Carolina and González-Bailón, Sandra},
  note={Revise and resubmit},
  year={2024}
}`
      }
    },
    {
      id: 3,
      title: "Expression at the Edge: Free Speech Boundaries Amidst the Gaza Crisis",
      authors: "Yphtach Lelkes, Ran Abramitzky, Tamar Mitts, and Hani Mansour",
      status: "revise and resubmit",
      categories: ['Conflict', 'Governance'],
      abstract: "This study examines how college students navigate the tension between free speech and harm prevention, highlighted by recent campus protests around the war in Gaza. Using online survey experiments with 3,065 college students nationwide, we find that the severity of speech and the target’s identity strongly influence support for disciplinary actions in response to objectionable speech. Students generally oppose punishing objectionable speech unless it is deemed highly harmful. Hateful rhetoric targeting minority groups, such as Black, Jewish, Muslim, and transgender individuals, elicits stronger punitive responses than identical statements directed at White students. While students, on average, afford greater protections to minority groups, there is notable variation. Exploratory analysis reveals that students’ responses are shaped by normative principles: about two-thirds believe minority groups should receive greater protection from harmful speech, while one-third advocate universal, equal treatment regardless of the target’s identity. These principles predict responses to speech scenarios, beyond ideology, stance on the Israeli-Palestinian conflict, and other personal characteristics. However, commitment to these principles weakens when individuals have a strong stance on the topic. These findings shed light on how college students balance competing principles of fairness and harm prevention in polarized contexts, offering insights into contemporary campus debates about free speech and inclusion.",
      links: {
        pdf: "https://osf.io/preprints/osf/mc6u3_v2",
        bibtex: `@unpublished{grossman2024expression,
  title={Expression at the Edge: Free Speech Boundaries Amidst the Gaza Crisis},
  author={Grossman, Guy and Lelkes, Yphtach and Abramitzky, Ran and Mitts, Tamar and Mansour, Hani},
  note={Revise and resubmit},
  year={2024}
}`
  }
    },
  {
      id: 4,
      title: "Calculation and Conscience: Motivations for the Substantive Representation of Ethnic Minorities",
      authors: "Apurav Bhatiya, William Dinneen, and Stephanie Zonszein",
      status: "revise and resubmit",
      categories: ['Migration'],
      abstract: "A vast body of work shows that minority legislators are more likely to represent their group's interests compared to dominant group legislators. However, it is unclear whether this is due to intrinsic motivations or electoral incentives. We use a regression discontinuity design (RDD) to analyze ethnic minority representation in the UK Parliament. By comparing white MPs who narrowly beat minority candidates to minority MPs who narrowly beat white candidates, the RDD controls for electoral incentives since it holds constant constituency factors correlated with a minority parliamentary win. Analyzing over 1 million parliamentary questions and speeches, we find that minority MPs are more likely than white MPs to discuss issues important to ethnic minorities. Additional evidence supports that narrowly elected MPs face similar electoral incentives, and that minority MPs representing minorities face reelection penalties. Our findings suggest that minority substantive representation is driven at least in part by intrinsic motivations.",
      links: {
        pdf: "https://osf.io/preprints/osf/hfm35_v2",
        bibtex: `@unpublished{grossman2024calculation,
  title={Calculation and Conscience: Motivations for the Substantive Representation of Ethnic Minorities},
  author={Grossman, Guy and Bhatiya, Apurav and Dinneen, William and Zonszein, Stephanie},
  note={Revise and resubmit},
  year={2024}
}`
      }
    },
    {
      id: 5,
      title: "The Credibility Revolution in Political Science",
      authors: "Carolina Torreblanca, William Dinneen, and Yiqing Xu",
      status: "under review",
      categories: ['Knowledge Production'],
      abstract: "How has the credibility revolution reshaped political science? We address this question by using a large language model to classify 91,632 articles published between 2003 and 2023 across 174 political science journals, focusing on causal research designs, transparency practices, and citation patterns. Design-based studies—research strategies that explicitly a research design and the assumptions required for causal identification—have become increasingly common, displacing regression-based analyses that rely primarily on modeling assumptions. Yet as of 2023, studies without an explicit identification strategy still constitute nearly 40% of empirical quantitative work. Within design-based research, survey experiments dominate, while field experiments and quasi-experimental approaches have grown more modestly. Transparency practices such as placebo tests and power analysis remain rare. Design-based studies are concentrated in top journals and among authors at highly ranked institutions, and enjoy a persistent citation premium. The credibility revolution has meaningfully reshaped the discipline, though unevenly and incompletely",
      links: {
        pdf: "https://osf.io/preprints/socarxiv/w2kmc_v1",
        bibtex: `@unpublished{grossman2024credibility,
  title={The Credibility Revolution in Political Science},
  author={Grossman, Guy and Torreblanca, Carolina and Dinneen, William and Xu, Yiqing},
  note={Under review},
  year={2024}
}`
      }
    },

    {
      id: 6,
      title: "Liberalizing Refugee Hosting Policies without Losing the Vote",
      authors: "Yang-Yang Zhou, Naijia Liu, and Shuning Ge",
      status: "under review",
      categories: ['Migration'],
      abstract: "Inclusive refugee policies -- granting refugees the right to work, use public services, and move freely -- benefit both refugees and host countries' economies. Yet many governments hesitate to liberalize such policies, fearing electoral backlash. Can governments minimize backlash by pairing expansions of refugee rights with policies that reduce burdens on host communities? We examine this question in Uganda, Africa's largest refugee hosting country. Alongside refugee policy liberalization, Uganda mandated reallocating a share of refugee aid to communities near refugee centers. Combining refugee settlement data with election returns (2001--2021) and a generalized difference-in-differences design, we show first that the vote share of the incumbent president was significantly lower in areas with high refugee presence before the 2010 reforms. Afterwards, a one standard deviation increase in refugee presence was associated with a four percentage point increase in the vote share of the incumbent government. Using public goods data, public opinion surveys, newspaper data, and parliamentary speech records, we find that infrastructure investments in hosting communities and the reluctance of opposition parties to rally against popular policies account for our findings.",
      links: {
        pdf: "https://osf.io/preprints/osf/94tpy_v5",
        bibtex: `@unpublished{grossman2024liberalizing,
  title={Liberalizing Refugee Hosting Policies without Losing the Vote},
  author={Grossman, Guy and Zhou, Yang-Yang and Liu, Naijia and Ge, Shuning},
  note={Under review},
  year={2024}
}`
      }
    }
  ];

  const normalize = (s) => (s || "").toString().toLowerCase();
  const uniq = (arr) => Array.from(new Set(arr));
  const escapeHtml = (s) =>
    (s || "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");

  const scholarUrlForTitle = (title) =>
    `https://scholar.google.com/scholar?q=${encodeURIComponent(title || "")}`;

  const state = { tab: "published", q: "", year: null, cats: new Set() };

  const getActiveData = () => (state.tab === "published" ? PUBLISHED : WORKING);

  const getAllYears = (data) => uniq(data.map((d) => d.year)).sort((a, b) => b - a);

  const getAllCategories = (data) => {
    const out = [];
    data.forEach((d) => (d.categories || []).forEach((c) => out.push(c)));
    return uniq(out).sort((a, b) => a.localeCompare(b));
  };

  const matches = (p) => {
    const q = normalize(state.q).trim();
    const inQ =
      !q ||
      normalize(p.title).includes(q) ||
      normalize(p.authors).includes(q) ||
      normalize(p.journal).includes(q);

    const inYear = state.year == null || p.year === state.year;

    const inCats =
      state.cats.size === 0 || (p.categories || []).some((c) => state.cats.has(c));

    return inQ && inYear && inCats;
  };

  const groupByYear = (items) => {
    const map = new Map();
    items.forEach((p) => {
      if (!map.has(p.year)) map.set(p.year, []);
      map.get(p.year).push(p);
    });
    return Array.from(map.entries()).sort((a, b) => b[0] - a[0]);
  };

  const formatVenue = (p) => {
    const bits = [];
    if (p.journal) bits.push(p.journal);
    const vol = (p.volume || "").trim();
    const iss = (p.issue || "").trim();
    const pag = (p.pages || "").trim();
    let vip = "";
    if (vol) vip += vol;
    if (iss) vip += (vip ? `(${iss})` : `(${iss})`);
    if (pag) vip += (vip ? `: ${pag}` : pag);
    if (vip) bits.push(vip);
    return bits.join(" • ");
  };

  function render() {
    const mount = document.getElementById("pubs-app");
    if (!mount) return;

    const data = getActiveData();
    const years = getAllYears(data);
    const cats = getAllCategories(data);

    const filtered = data.filter(matches);
    const grouped = groupByYear(filtered);

    mount.innerHTML = `
      <div class="pubs-ui">
        <aside class="pubs-sidebar">
          <div class="pubs-panel">
            <div style="display:flex; justify-content:center; margin-bottom:0.75rem;">
              <div class="pubs-tabs" role="tablist" aria-label="Publications tabs">
                <button class="pubs-tab ${state.tab === "published" ? "is-active" : ""}" data-tab="published" type="button">Published</button>
                <button class="pubs-tab ${state.tab === "working" ? "is-active" : ""}" data-tab="working" type="button">Under review</button>
              </div>
            </div>

            <h3>Search</h3>
            <input class="pubs-field" id="pubs-search" type="search" placeholder="Search title, author, journal" value="${escapeHtml(state.q)}"/>

            <div style="height:0.9rem"></div>

            <h3>Years</h3>
            <div class="pubs-yeargrid" id="pubs-years">
              ${renderYearGrid(years, data)}
            </div>

            <div style="height:0.9rem"></div>

            <h3>Categories</h3>
            <div class="pubs-chipwrap" id="pubs-cats">
              ${renderCategoryChips(cats, data)}
            </div>

            <div style="height:0.9rem"></div>

            <button class="pubs-action pubs-action--primary" id="pubs-clear" type="button">Clear filters</button>
          </div>
        </aside>

        <main class="pubs-main">
          ${filtered.length ? renderCards(grouped) : `<div class="pubs-empty">No results. Try clearing filters.</div>`}
        </main>
      </div>
          `;

    bindHandlers();
  }

  function renderYearGrid(years, data) {
    const total = data.length;
    const counts = new Map();
    data.forEach((p) => counts.set(p.year, (counts.get(p.year) || 0) + 1));

    const allActive = state.year == null ? "is-active" : "";
    const allBtn = `
        <button class="pubs-yearbtn ${allActive}" data-year="">
          All (${total})
        </button>`;

    const yearBtns = years
      .map((y) => {
        const active = state.year === y ? "is-active" : "";
        return `
        <button class="pubs-yearbtn ${active}" data-year="${y}">
          ${y} (${counts.get(y) || 0})
        </button>`;
      })
      .join("");

    return allBtn + yearBtns;
  }


  function matchesWithoutCats(p) {
    // Apply search + year filters, ignore category selection (used for sidebar counts)
    const q = state.q.trim().toLowerCase();
    if (q) {
      const hay = `${p.title} ${p.authors} ${p.journal}`.toLowerCase();
      if (!hay.includes(q)) return false;
    }
    if (state.year != null && p.year !== state.year) return false;
    return true;
  }

  function renderCategoryChips(cats, data) {
    if (!cats.length) return `<span class="pubs-empty" style="padding:.5rem .75rem;">No categories</span>`;

    const base = data.filter(matchesWithoutCats);
    const counts = new Map();
    base.forEach((p) => (p.categories || []).forEach((c) => counts.set(c, (counts.get(c) || 0) + 1)));

    return cats
      .map((c) => {
        const active = state.cats.has(c) ? "is-active" : "";
        const n = counts.get(c) || 0;
        return `<button class="pubs-chip ${active}" type="button" data-cat="${escapeHtml(c)}">${escapeHtml(c)} (${n})</button>`;
      })
      .join("");
  }

  function renderChip(cat) {
    const active = state.cats.has(cat) ? "is-active" : "";
    return `<button class="pubs-chip ${active}" type="button" data-cat="${escapeHtml(cat)}">${escapeHtml(cat)}</button>`;
  }

  function renderCards(grouped) {
    return grouped
      .map(([year, items]) => {
        return `
          <div class="pubs-yearhdr">${year}</div>
          ${items.map(renderCard).join("")}
        `;
      })
      .join("");
  }

  function renderCard(p) {
    const titleHtml = p.links?.webpage
      ? `<a href="${p.links.webpage}" target="_blank" rel="noopener noreferrer">${escapeHtml(p.title)}</a>`
      : escapeHtml(p.title);

    const venue = formatVenue(p);
    const cats = (p.categories || []).map((c) => `<span class="pubs-badge">${escapeHtml(c)}</span>`).join("");

    const btns = [];
    if (p.links?.pdf) btns.push(actionLink("PDF", p.links.pdf, true));
    (p.links?.appendix || []).forEach((u, i) => btns.push(actionLink(i === 0 ? "Appendix" : `App ${i+1}`, u)));
    if (p.links?.replication) btns.push(actionLink("Replication", p.links.replication));
    btns.push(actionLink("Scholar", p.links?.scholar || scholarUrlForTitle(p.title)));
    if (p.links?.bibtex) btns.push(`<button class="pubs-action" type="button" data-bibbtn="${p.id}">BibTeX</button>`);
const abs = p.abstract ? `<details><summary>Abstract</summary><div style="margin-top:.35rem">${escapeHtml(p.abstract)}</div></details>` : "";

    return `
      <article class="pubs-card" id="pub-${p.id}">
        <h4>${titleHtml}</h4>
        <div class="pubs-meta">
          ${escapeHtml(p.authors)}${venue ? ` • ${escapeHtml(venue)}` : ""}${p.status ? ` • ${escapeHtml(p.status)}` : ""}
        </div>

        ${cats ? `<div class="pubs-badges">${cats}</div>` : ""}

        ${abs}

        <div class="pubs-actions">
          ${btns.join("")}
        </div>

        ${p.links?.bibtex ? `
          <div class="pubs-bibpanel" data-bib="${p.id}">
            <div class="pubs-bibhead">
              <div class="pubs-bibtitle">BibTeX</div>
              <button class="pubs-copybtn" type="button" data-bibcopy="${p.id}" aria-label="Copy BibTeX">Copy</button>
            </div>
            <pre class="pubs-bibpre">${escapeHtml(p.links.bibtex)}</pre>
          </div>
        ` : ""}

        <div class="pubs-bibtex" data-bib="${p.id}">
          <pre><code>${escapeHtml(p.links?.bibtex || "")}</code></pre>
        </div>
      </article>
    `;
  }

  function actionLink(label, url, primary = false) {
    const cls = `pubs-action${primary ? " pubs-action--primary" : ""}`;
    return `<a class="${cls}" href="${url}" target="_blank" rel="noopener noreferrer">${escapeHtml(label)}</a>`;
  }

function bindHandlers() {
    document.querySelectorAll(".pubs-tab").forEach((b) => {
      b.addEventListener("click", () => {
        const tab = b.getAttribute("data-tab");
        if (!tab || tab === state.tab) return;
        state.tab = tab;
        state.q = "";
        state.year = null;
        state.cats = new Set();
        render();
      });
    });

    const search = document.getElementById("pubs-search");
    if (search) {
      search.addEventListener("input", () => {
        state.q = search.value || "";
        render();
      });
    }

    document.querySelectorAll("#pubs-years button").forEach((b) => {
      b.addEventListener("click", () => {
        const y = b.getAttribute("data-year");
        state.year = y ? Number(y) : null;
        render();
      });
    });

    document.querySelectorAll("#pubs-cats .pubs-chip").forEach((b) => {
      b.addEventListener("click", () => {
        const c = b.getAttribute("data-cat");
        if (!c) return;
        if (state.cats.has(c)) state.cats.delete(c);
        else state.cats.add(c);
        render();
      });
    });

    const clear = document.getElementById("pubs-clear");
    if (clear) {
      clear.addEventListener("click", () => {
        state.q = "";
        state.year = null;
        state.cats = new Set();
        render();
      });
    }

    document.querySelectorAll("[data-bibbtn]").forEach((b) => {
      b.addEventListener("click", () => {
        const id = b.getAttribute("data-bibbtn");
        const panel = document.querySelector(`[data-bib="${CSS.escape(id)}"]`);
        if (!panel) return;
        panel.classList.toggle("is-open");
      });
    });

    // BibTeX copy
    document.querySelectorAll("[data-bibcopy]").forEach((b) => {
      b.addEventListener("click", async () => {
        const id = b.getAttribute("data-bibcopy");
        if (!id) return;
        const p = getActiveData().find((x) => String(x.id) === String(id));
        const bib = p?.links?.bibtex || "";
        if (!bib) return;

        try {
          await navigator.clipboard.writeText(bib);
          } catch (e) {
          const ta = document.createElement("textarea");
          ta.value = bib;
          ta.setAttribute("readonly", "");
          ta.style.position = "fixed";
          ta.style.top = "-1000px";
          document.body.appendChild(ta);
          ta.select();
          try { document.execCommand("copy"); }
          catch (err) { }
          document.body.removeChild(ta);
        }
      });
    });
  }

  document.addEventListener("DOMContentLoaded", render);
})();